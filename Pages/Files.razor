@page "/files"
@using DiskMountUtility.Application.Services
@using DiskMountUtility.Application.DTOs
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.JSInterop
@using Microsoft.AspNetCore.StaticFiles;
@inject ProtectedSessionStorage SessionStorage
@inject DiskManagementService DiskService
@inject NavigationManager Navigation
@inject IJSRuntime JS
@implements IAsyncDisposable

<PageTitle>File Explorer - @(mountedDisk?.Name ?? "No Disk")</PageTitle>

<div class="container">
    <div class="header">
        <h1>File Explorer @(mountedDisk != null ? $"- {mountedDisk.Name}" : "")</h1>
        <button type="button" class="btn btn-secondary" @onclick="NavigateBack">Back to Dashboard</button>
    </div>

    @if (mountedDisk == null)
    {
        <div class="empty-state">
            <h2>No Disk Mounted</h2>
            <p>Please mount a disk first to browse files</p>
            <button type="button" class="btn btn-primary" @onclick="NavigateBack">Go to Dashboard</button>
        </div>
    }
    else
    {
        <div class="file-explorer">
            <div class="toolbar">
                <div class="breadcrumb">
                    @foreach (var part in GetPathParts())
                    {
                        <span class="separator">/</span>
                        <span @onclick="() => NavigateToPath(part.path)" style="cursor:pointer">@part.name</span>
                    }
                </div>
                <div class="actions">
                    <button type="button" class="btn btn-primary" @onclick="ShowUploadDialog">Upload File</button>
                    <button type="button" class="btn btn-secondary" @onclick="ShowCreateFolderDialog">New Folder</button>
                    <button type="button" class="btn btn-info" @onclick="RefreshFiles" disabled="@isRefreshing">
                        🔄 @(isRefreshing ? "Refreshing..." : "Refresh")
                    </button>
                </div>
            </div>

            <div class="files-list">
                @if (files.Any())
                {
                    <table class="files-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Size</th>
                                <th>Modified</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var file in files)
                            {
                                <tr>
                                    <td>
                                        @if (file.IsDirectory)
                                        {
                                            <span class="folder-icon" style="cursor:pointer" @onclick="() => NavigateToPath(file.Path)">
                                                📁 @file.Name
                                            </span>
                                        }
                                        else
                                        {
                                            <span class="file-icon">📄 @file.Name</span>
                                        }
                                    </td>
                                    <td>@file.FormattedSize</td>
                                    <td>@file.ModifiedAt.ToLocalTime().ToString("g")</td>
                                    <td>
                                        @if (!file.IsDirectory)
                                        {
                                            <button type="button" class="btn-small btn-info" @onclick="() => PreviewFile(file.Path)">Preview</button>
                                            <button type="button" class="btn-small btn-primary" @onclick="() => DownloadFile(file.Path)">Download</button>
                                        }
                                        <button type="button" class="btn-small btn-danger" @onclick="() => DeleteFile(file.Path)">Delete</button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                }
                else
                {
                    <p class="no-files">This folder is empty</p>
                }
            </div>
        </div>
    }
</div>

@if (showUploadDialog)
{
    <div class="modal-overlay" @onclick="CloseDialogs" style="z-index:2000;">
        <div class="modal" @onclick:stopPropagation="true">
            <h2>Upload File</h2>
            <div class="form-group">
                <label>Select File</label>
                <InputFile OnChange="HandleFileSelected" />
                @if (!string.IsNullOrEmpty(selectedFileName))
                {
                    <p><b>Selected:</b> @selectedFileName</p>
                }
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }
            <div class="modal-actions">
                <button type="button" class="btn btn-success" @onclick="UploadSelectedFile" disabled="@(!CanUpload)">
                    @(isProcessing ? "Uploading..." : "Upload")
                </button>
                <button type="button" class="btn btn-secondary" @onclick="CloseDialogs">Cancel</button>
            </div>
        </div>
    </div>
}

@if (showCreateFolderDialog)
{
    <div class="modal-overlay" @onclick="CloseDialogs" style="z-index:2000;">
        <div class="modal" @onclick:stopPropagation="true">
            <h2>Create Folder</h2>
            <div class="form-group">
                <label>Folder Name</label>
                <input type="text" class="form-control" @bind="newFolderName" placeholder="My Folder" />
            </div>
            @if (!string.IsNullOrEmpty(errorMessage))
            {
                <div class="error-message">@errorMessage</div>
            }
            <div class="modal-actions">
                <button type="button" class="btn btn-success" @onclick="CreateFolder" disabled="@isProcessing">
                    @(isProcessing ? "Creating..." : "Create")
                </button>
                <button type="button" class="btn btn-secondary" @onclick="CloseDialogs">Cancel</button>
            </div>
        </div>
    </div>
}

@if (showPreviewModal)
{
    <div class="modal-overlay" @onclick="ClosePreview" style="z-index:3000;">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>@previewFileName</h3>

            @if (previewType == "text")
            {
                <div class="preview-text-container">@previewText</div>
            }
            else if (previewType == "image")
            {
                <img src="@($"data:{previewContentType};base64,{previewBase64}")"
                     alt="@previewFileName"
                     style="max-width:100%; max-height:70vh; border-radius:6px;" />
            }
            else if (previewType == "pdf")
            {
                <iframe src="@($"data:application/pdf;base64,{previewBase64}")"
                        width="100%" height="600px" style="border:none; border-radius:6px;"></iframe>
            }
            else if (previewType == "video")
            {
                <video controls style="max-width:100%; max-height:70vh; border-radius:6px;">
                    <source src="@($"data:{previewContentType};base64,{previewBase64}")" type="@previewContentType" />
                    Your browser does not support the video tag.
                </video>
            }
            else
            {
                <p style="color:#666; text-align:center; padding:2rem;">Preview not supported for this file type.</p>
            }

            <div style="margin-top: 1.5rem; text-align: right;">
                <button type="button" class="btn btn-secondary" @onclick="ClosePreview">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private DiskInfoResponse? mountedDisk;
    private List<FileInfoResponse> files = new();
    private string currentPath = "/";
    private bool showUploadDialog = false;
    private bool showCreateFolderDialog = false;
    private bool isProcessing = false;
    private bool isRefreshing = false;
    private string errorMessage = string.Empty;

    private string newFolderName = string.Empty;
    private IBrowserFile? selectedFile;
    private string selectedFileName = string.Empty;
    private bool CanUpload => !isProcessing && selectedFile != null;
    private bool showPreviewModal = false;
    private string previewFileName = string.Empty;
    private string previewBase64 = string.Empty;
    private string previewText = string.Empty;
    private string previewType = string.Empty;
    private string previewContentType = string.Empty;

    private string? _subscriptionId;

    protected override async Task OnInitializedAsync()
    {
        await LoadMountedDisk();
        await LoadFiles();

        _subscriptionId = DiskService.SubscribeToFileChanges(async () =>
        {
            Console.WriteLine("📢 File change detected, refreshing UI...");
            await InvokeAsync(async () =>
            {
                isRefreshing = true;
                StateHasChanged();

                try
                {
                    await LoadFiles();
                }
                catch (Exception ex)
                {
                    Console.WriteLine($"Error loading files: {ex.Message}");
                    errorMessage = "Failed to refresh files";
                }
                finally
                {
                    isRefreshing = false;
                    StateHasChanged();
                }
            });
        });
    }

    private async Task LoadMountedDisk()
    {
        mountedDisk = await DiskService.GetMountedDiskInfoAsync();
    }

    private async Task LoadFiles()
    {
        if (mountedDisk != null)
            files = await DiskService.GetFilesAsync(mountedDisk.Id, currentPath);
    }

    private async Task RefreshFiles()
    {
        isRefreshing = true;
        try
        {
            await LoadFiles();
        }
        finally
        {
            isRefreshing = false;
        }
        StateHasChanged();
    }

    private void ShowUploadDialog()
    {
        selectedFile = null;
        selectedFileName = string.Empty;
        errorMessage = string.Empty;
        showUploadDialog = true;
        StateHasChanged();
    }

    private void ShowCreateFolderDialog()
    {
        newFolderName = string.Empty;
        errorMessage = string.Empty;
        showCreateFolderDialog = true;
        StateHasChanged();
    }

    private void CloseDialogs()
    {
        showUploadDialog = false;
        showCreateFolderDialog = false;
        errorMessage = string.Empty;
        StateHasChanged();
    }

    private async Task HandleFileSelected(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        selectedFileName = selectedFile.Name;
        StateHasChanged();
    }

    private async Task UploadSelectedFile()
    {
        if (mountedDisk == null || selectedFile == null)
        {
            errorMessage = "Please select a file to upload.";
            return;
        }

        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            var maxAllowedSize = mountedDisk?.SizeInBytes > 0
                ? Math.Min(mountedDisk.SizeInBytes, 10L * 1024 * 1024 * 1024)
                : 10L * 1024 * 1024;

            using var stream = selectedFile.OpenReadStream(maxAllowedSize);
            using var ms = new MemoryStream();
            await stream.CopyToAsync(ms);
            var fileBytes = ms.ToArray();

            var request = new WriteFileRequest
            {
                Path = currentPath,
                FileName = selectedFile.Name,
                Content = fileBytes
            };

            var success = await DiskService.WriteFileAsync(mountedDisk.Id, request);
            if (success)
            {
                await LoadFiles();
                CloseDialogs();
            }
            else
            {
                errorMessage = "Failed to upload file. Check disk space or encryption issues.";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Upload failed: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task CreateFolder()
    {
        if (mountedDisk == null || string.IsNullOrWhiteSpace(newFolderName))
        {
            errorMessage = "Please enter a folder name";
            return;
        }

        isProcessing = true;
        errorMessage = string.Empty;

        try
        {
            var folderPath = currentPath == "/" ? $"/{newFolderName}" : $"{currentPath}/{newFolderName}";
            var success = await DiskService.CreateDirectoryAsync(mountedDisk.Id, folderPath);

            if (success)
            {
                await LoadFiles();
                CloseDialogs();
            }
            else
            {
                errorMessage = "Failed to create folder";
            }
        }
        catch (Exception ex)
        {
            errorMessage = $"Error: {ex.Message}";
        }
        finally
        {
            isProcessing = false;
            StateHasChanged();
        }
    }

    private async Task DownloadFile(string path)
    {
        if (mountedDisk == null) return;

        try
        {
            var content = await DiskService.ReadFileAsync(mountedDisk.Id, path);
            if (content == null)
            {
                errorMessage = "File not found or failed to read content.";
                return;
            }

            var fileName = Path.GetFileName(path);
            var base64 = Convert.ToBase64String(content);

            await JS.InvokeVoidAsync("downloadFileFromBase64", fileName, base64);

            Console.WriteLine($"File '{fileName}' downloaded successfully.");
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to download file: {ex.Message}";
        }
    }

    private async Task DeleteFile(string path)
    {
        if (mountedDisk == null) return;

        try
        {
            await DiskService.DeleteFileAsync(mountedDisk.Id, path);
            await LoadFiles();
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to delete file: {ex.Message}";
        }
    }

    private async Task PreviewFile(string path)
    {
        if (mountedDisk == null) return;

        try
        {
            var content = await DiskService.ReadFileAsync(mountedDisk.Id, path);
            if (content == null)
            {
                errorMessage = "Failed to read file for preview.";
                return;
            }

            previewFileName = Path.GetFileName(path);
            previewBase64 = Convert.ToBase64String(content);
            previewText = string.Empty;
            previewType = string.Empty;

            var provider = new FileExtensionContentTypeProvider();
            if (!provider.TryGetContentType(previewFileName, out previewContentType))
                previewContentType = "application/octet-stream";

            var ext = Path.GetExtension(previewFileName).ToLower();

            switch (ext)
            {
                case ".jpg":
                case ".jpeg":
                case ".png":
                case ".gif":
                case ".bmp":
                case ".webp":
                    previewType = "image";
                    break;

                case ".mp4":
                case ".webm":
                case ".mov":
                case ".avi":
                    previewType = "video";
                    break;

                case ".pdf":
                    previewType = "pdf";
                    break;

                case ".txt":
                case ".log":
                case ".json":
                case ".xml":
                case ".csv":
                case ".cs":
                case ".js":
                case ".html":
                case ".css":
                case ".md":
                    previewType = "text";
                    previewText = Encoding.UTF8.GetString(content);
                    break;

                default:
                    previewType = "unsupported";
                    break;
            }

            showPreviewModal = true;
            StateHasChanged();
        }
        catch (Exception ex)
        {
            errorMessage = $"Preview failed: {ex.Message}";
        }
    }

    private async Task NavigateToPath(string path)
    {
        currentPath = path;
        await LoadFiles();
        StateHasChanged();
    }

    private void ClosePreview()
    {
        showPreviewModal = false;
        previewBase64 = previewText = string.Empty;
        previewType = string.Empty;
        StateHasChanged();
    }

    private List<(string name, string path)> GetPathParts()
    {
        if (currentPath == "/") return new();

        var parts = currentPath.Split('/', StringSplitOptions.RemoveEmptyEntries);
        var result = new List<(string, string)>();
        var accumulated = "";

        foreach (var part in parts)
        {
            accumulated += "/" + part;
            result.Add((part, accumulated));
        }

        return result;
    }

    private void NavigateBack() => Navigation.NavigateTo("/");

    async ValueTask IAsyncDisposable.DisposeAsync()
    {
        if (!string.IsNullOrEmpty(_subscriptionId))
        {
            DiskService.UnsubscribeFromFileChanges(_subscriptionId);
        }
        await ValueTask.CompletedTask;
    }
}